(function () {
var module;

module = angular.module('maestrano.analytics.widget-accounts-custom-calculation', ['maestrano.assets']);

module.controller('WidgetAccountsCustomCalculationCtrl', [
  '$scope', '$timeout', '$modal', 'DhbAnalyticsSvc', 'TemplatePath', 'AssetPath', function($scope, $timeout, $modal, DhbAnalyticsSvc, TemplatePath, AssetPath) {
    var getSettingsCount, w;
    w = $scope.widget;
    $scope.loaderImage = AssetPath['loader-white-bg.gif'];
    w.initContext = function() {
      $scope.movedAccount = {};
      return $scope.isDataFound = (w.content != null) && !_.isEmpty(w.content.complete_list);
    };
    $scope.addAccountToFormula = function(account) {
      if (w.selectedAccounts.length > 0) {
        w.formula += " + {" + (w.selectedAccounts.length + 1) + "}";
      } else {
        w.formula = "{1}";
      }
      return w.moveAccountToAnotherList(account, w.remainingAccounts, w.selectedAccounts, false);
    };
    $scope.removeAccountFromFormula = function(account) {
      var diffAccountIndex, diffAccountUid, i, indexPattern, newFormula, nextUids, prevUids, removePattern;
      prevUids = _.map(w.selectedAccounts, function(e) {
        return e.uid;
      });
      nextUids = _.reject(prevUids, function(e) {
        return e === account.uid;
      });
      diffAccountUid = _.first(_.difference(prevUids, nextUids));
      diffAccountIndex = _.indexOf(prevUids, diffAccountUid) + 1;
      if (diffAccountIndex === 1) {
        removePattern = "{" + diffAccountIndex + "\\}\\s*(-|\\*|\\/|\\+)*\\s*";
      } else {
        removePattern = "\\s*(-|\\*|\\/|\\+)*\\s*\\{" + diffAccountIndex + "\\}";
      }
      newFormula = angular.copy(w.formula).replace(new RegExp(removePattern, 'g'), '');
      i = diffAccountIndex + 1;
      while (i <= prevUids.length) {
        indexPattern = "\\{" + i + "\\}";
        newFormula = newFormula.replace(new RegExp(indexPattern, 'g'), "{" + (i - 1) + "}");
        i++;
      }
      w.formula = angular.copy(newFormula);
      return w.moveAccountToAnotherList(account, w.selectedAccounts, w.remainingAccounts, false);
    };
    $scope.formulaModal = {};
    $scope.formulaModal.config = {
      instance: {
        backdrop: 'static',
        templateUrl: TemplatePath['analytics/modals/formula-modal.html'],
        size: 'lg',
        scope: $scope,
        keyboard: false
      }
    };
    $scope.formulaModal.open = function() {
      var self;
      w.settings = angular.copy(_.reject(w.settings, function(elem) {
        return elem.key === "organizations";
      }));
      self = $scope.formulaModal;
      self.$instance = $modal.open(self.config.instance);
      return $timeout(function() {
        return w.initSettings();
      }, 200);
    };
    $scope.$watch((function() {
      return w.selectedOrganizations;
    }), function(result) {
      if (!_.isEmpty(result)) {
        return w.updateSettings();
      }
    }, true);
    $scope.formulaModal.cancel = function() {
      w.initSettings();
      return $scope.formulaModal.close();
    };
    $scope.formulaModal.proceed = function() {
      w.updateSettings(false);
      return $scope.formulaModal.close();
    };
    $scope.formulaModal.close = function() {
      return $scope.formulaModal.$instance.close();
    };
    $scope.$watch((function() {
      return w.isEditMode;
    }), function(result, prev) {
      if (result && !prev) {
        return $scope.formulaModal.open();
      }
    });
    getSettingsCount = function() {
      if (w.settings != null) {
        return w.settings.length;
      } else {
        return 0;
      }
    };
    $scope.$watch(getSettingsCount, function(total) {
      if (total === 3 && !$scope.blockLoadContent) {
        w.loadContent();
        return $scope.blockLoadContent = true;
      }
    });
    return w;
  }
]);

module.directive('widgetAccountsCustomCalculation', function() {
  return {
    restrict: 'A',
    link: function(scope, element) {
      element.addClass("accounts");
      return element.addClass("custom-calculation");
    },
    controller: 'WidgetAccountsCustomCalculationCtrl'
  };
});
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndpZGdldHMvd2lkZ2V0LWFjY291bnRzLWN1c3RvbS1jYWxjdWxhdGlvbi5qcy5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBQTs7QUFBQSxNQUFBLEdBQVMsT0FBTyxDQUFDLE1BQVIsQ0FBZSx3REFBZixFQUF3RSxDQUFDLGtCQUFELENBQXhFOztBQUVULE1BQU0sQ0FBQyxVQUFQLENBQWtCLHFDQUFsQixFQUF3RDtFQUN0RCxRQURzRCxFQUM1QyxVQUQ0QyxFQUNoQyxRQURnQyxFQUN0QixpQkFEc0IsRUFDSCxjQURHLEVBQ2EsV0FEYixFQUV0RCxTQUFDLE1BQUQsRUFBUyxRQUFULEVBQW1CLE1BQW5CLEVBQTJCLGVBQTNCLEVBQTRDLFlBQTVDLEVBQTBELFNBQTFEO0FBRUUsUUFBQTtJQUFBLENBQUEsR0FBSSxNQUFNLENBQUM7SUFFWCxNQUFNLENBQUMsV0FBUCxHQUFxQixTQUFVLENBQUEscUJBQUE7SUFFL0IsQ0FBQyxDQUFDLFdBQUYsR0FBZ0IsU0FBQTtNQUNkLE1BQU0sQ0FBQyxZQUFQLEdBQXNCO2FBQ3RCLE1BQU0sQ0FBQyxXQUFQLEdBQXFCLG1CQUFBLElBQWMsQ0FBQyxDQUFDLENBQUMsT0FBRixDQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsYUFBcEI7SUFGdEI7SUFTaEIsTUFBTSxDQUFDLG1CQUFQLEdBQTZCLFNBQUMsT0FBRDtNQUUzQixJQUFHLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFuQixHQUE0QixDQUEvQjtRQUNFLENBQUMsQ0FBQyxPQUFGLElBQWEsTUFBQSxHQUFNLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLE1BQW5CLEdBQTRCLENBQTdCLENBQU4sR0FBcUMsSUFEcEQ7T0FBQSxNQUFBO1FBSUUsQ0FBQyxDQUFDLE9BQUYsR0FBWSxNQUpkOzthQU1BLENBQUMsQ0FBQyx3QkFBRixDQUEyQixPQUEzQixFQUFtQyxDQUFDLENBQUMsaUJBQXJDLEVBQXVELENBQUMsQ0FBQyxnQkFBekQsRUFB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QUQsRUFBUSxPQUFSO01BQ0osT0FBTyxDQUFDLFFBQVIsQ0FBaUIsVUFBakI7YUFDQSxPQUFPLENBQUMsUUFBUixDQUFpQixvQkFBakI7SUFGSSxDQUZEO0lBS0osVUFBQSxFQUFZLHFDQUxSOztBQUQyQyxDQUFwRCIsImZpbGUiOiJ3aWRnZXRzL3dpZGdldC1hY2NvdW50cy1jdXN0b20tY2FsY3VsYXRpb24uanMuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJtb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnbWFlc3RyYW5vLmFuYWx5dGljcy53aWRnZXQtYWNjb3VudHMtY3VzdG9tLWNhbGN1bGF0aW9uJyxbJ21hZXN0cmFuby5hc3NldHMnXSlcblxubW9kdWxlLmNvbnRyb2xsZXIoJ1dpZGdldEFjY291bnRzQ3VzdG9tQ2FsY3VsYXRpb25DdHJsJyxbXG4gICckc2NvcGUnLCAnJHRpbWVvdXQnLCAnJG1vZGFsJywgJ0RoYkFuYWx5dGljc1N2YycsICdUZW1wbGF0ZVBhdGgnLCAnQXNzZXRQYXRoJyxcbiAgKCRzY29wZSwgJHRpbWVvdXQsICRtb2RhbCwgRGhiQW5hbHl0aWNzU3ZjLCBUZW1wbGF0ZVBhdGgsIEFzc2V0UGF0aCkgLT5cblxuICAgIHcgPSAkc2NvcGUud2lkZ2V0XG5cbiAgICAkc2NvcGUubG9hZGVySW1hZ2UgPSBBc3NldFBhdGhbJ2xvYWRlci13aGl0ZS1iZy5naWYnXVxuXG4gICAgdy5pbml0Q29udGV4dCA9IC0+XG4gICAgICAkc2NvcGUubW92ZWRBY2NvdW50ID0ge31cbiAgICAgICRzY29wZS5pc0RhdGFGb3VuZCA9IHcuY29udGVudD8gJiYgIV8uaXNFbXB0eSh3LmNvbnRlbnQuY29tcGxldGVfbGlzdClcblxuXG4gICAgIyAjPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgIyAjIEZvcm11bGEgbWFuYWdlbWVudFxuICAgICMgIz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gICAgJHNjb3BlLmFkZEFjY291bnRUb0Zvcm11bGEgPSAoYWNjb3VudCkgLT5cbiAgICAgICMgV2hlbiBzb21lIGFjY291bnRzIGFyZSBhbHJlYWR5IGluIHNhdmVkTGlzdFxuICAgICAgaWYgdy5zZWxlY3RlZEFjY291bnRzLmxlbmd0aCA+IDBcbiAgICAgICAgdy5mb3JtdWxhICs9IFwiICsgeyN7dy5zZWxlY3RlZEFjY291bnRzLmxlbmd0aCArIDF9fVwiXG4gICAgICAjIE90aGVyd2lzZVxuICAgICAgZWxzZVxuICAgICAgICB3LmZvcm11bGEgPSBcInsxfVwiXG5cbiAgICAgIHcubW92ZUFjY291bnRUb0Fub3RoZXJMaXN0KGFjY291bnQsdy5yZW1haW5pbmdBY2NvdW50cyx3LnNlbGVjdGVkQWNjb3VudHMsZmFsc2UpXG5cbiAgICAkc2NvcGUucmVtb3ZlQWNjb3VudEZyb21Gb3JtdWxhID0gKGFjY291bnQpIC0+XG4gICAgICBwcmV2VWlkcyA9IF8ubWFwKHcuc2VsZWN0ZWRBY2NvdW50cywgKGUpIC0+XG4gICAgICAgIGUudWlkXG4gICAgICApXG4gICAgICBuZXh0VWlkcyA9IF8ucmVqZWN0KHByZXZVaWRzLCAoZSkgLT5cbiAgICAgICAgZSA9PSBhY2NvdW50LnVpZFxuICAgICAgKVxuXG4gICAgICBkaWZmQWNjb3VudFVpZCA9IF8uZmlyc3QoXy5kaWZmZXJlbmNlKHByZXZVaWRzLG5leHRVaWRzKSlcbiAgICAgIGRpZmZBY2NvdW50SW5kZXggPSBfLmluZGV4T2YocHJldlVpZHMsIGRpZmZBY2NvdW50VWlkKSArIDFcbiAgICAgIFxuICAgICAgaWYgZGlmZkFjY291bnRJbmRleCA9PSAxXG4gICAgICAgICMgV2UgcmVtb3ZlIHRoZSBuZXh0IG9wZXJhdG9yXG4gICAgICAgIHJlbW92ZVBhdHRlcm4gPSBcInsje2RpZmZBY2NvdW50SW5kZXh9XFxcXH1cXFxccyooLXxcXFxcKnxcXFxcL3xcXFxcKykqXFxcXHMqXCJcbiAgICAgIGVsc2VcbiAgICAgICAgIyBXZSByZW1vdmUgdGhlIHByZXZpb3VzIG9wZXJhdG9yXG4gICAgICAgIHJlbW92ZVBhdHRlcm4gPSBcIlxcXFxzKigtfFxcXFwqfFxcXFwvfFxcXFwrKSpcXFxccypcXFxceyN7ZGlmZkFjY291bnRJbmRleH1cXFxcfVwiXG4gICAgICBuZXdGb3JtdWxhID0gYW5ndWxhci5jb3B5KHcuZm9ybXVsYSkucmVwbGFjZShuZXcgUmVnRXhwKHJlbW92ZVBhdHRlcm4sICdnJyksJycpXG4gICAgICBcbiAgICAgICMgV2UgZG93bmdyYWRlIGFsbCB0aGUgbmV4dCBpbmRleGVzXG4gICAgICBpID0gZGlmZkFjY291bnRJbmRleCArIDFcbiAgICAgIHdoaWxlIGkgPD0gcHJldlVpZHMubGVuZ3RoXG4gICAgICAgIGluZGV4UGF0dGVybiA9IFwiXFxcXHsje2l9XFxcXH1cIlxuICAgICAgICBuZXdGb3JtdWxhID0gbmV3Rm9ybXVsYS5yZXBsYWNlKG5ldyBSZWdFeHAoaW5kZXhQYXR0ZXJuLCAnZycpLCBcInsje2ktMX19XCIpXG4gICAgICAgIGkrK1xuXG4gICAgICB3LmZvcm11bGEgPSBhbmd1bGFyLmNvcHkobmV3Rm9ybXVsYSlcbiAgICAgIHcubW92ZUFjY291bnRUb0Fub3RoZXJMaXN0KGFjY291bnQsdy5zZWxlY3RlZEFjY291bnRzLHcucmVtYWluaW5nQWNjb3VudHMsZmFsc2UpXG5cbiAgICAjPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgIyBNb2RhbCBtYW5hZ2VtZW50XG4gICAgIz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gICAgJHNjb3BlLmZvcm11bGFNb2RhbCA9IHt9XG4gICAgJHNjb3BlLmZvcm11bGFNb2RhbC5jb25maWcgPSB7XG4gICAgICBpbnN0YW5jZToge1xuICAgICAgICBiYWNrZHJvcDogJ3N0YXRpYydcbiAgICAgICAgdGVtcGxhdGVVcmw6IFRlbXBsYXRlUGF0aFsnYW5hbHl0aWNzL21vZGFscy9mb3JtdWxhLW1vZGFsLmh0bWwnXVxuICAgICAgICBzaXplOiAnbGcnXG4gICAgICAgIHNjb3BlOiAkc2NvcGVcbiAgICAgICAga2V5Ym9hcmQ6IGZhbHNlXG4gICAgICB9XG4gICAgfVxuXG4gICAgJHNjb3BlLmZvcm11bGFNb2RhbC5vcGVuID0gLT5cbiAgICAgICMgQSBuZXcgb3JnYW5pemF0aW9uIHNldHRpbmcgZGlyZWN0aXZlIGlzIGdvaW5nIHRvIGJlIGluc2VydGVkIHZpYSB0aGUgbW9kYWxcbiAgICAgICMgYmVmb3JlIGxvYWRpbmcgaXQsIHdlIHJlbW92ZSB0aGUgaW5pdGlhbCBzZXR0aW5nXG4gICAgICB3LnNldHRpbmdzID0gYW5ndWxhci5jb3B5KF8ucmVqZWN0IHcuc2V0dGluZ3MsIChlbGVtKSAtPlxuICAgICAgICBlbGVtLmtleSA9PSBcIm9yZ2FuaXphdGlvbnNcIlxuICAgICAgKVxuICAgICAgc2VsZiA9ICRzY29wZS5mb3JtdWxhTW9kYWxcbiAgICAgIHNlbGYuJGluc3RhbmNlID0gJG1vZGFsLm9wZW4oc2VsZi5jb25maWcuaW5zdGFuY2UpXG4gICAgICAkdGltZW91dCAtPlxuICAgICAgICB3LmluaXRTZXR0aW5ncygpXG4gICAgICAsMjAwXG5cbiAgICAjICMgIyBSZWxvYWQgdGhlIGFjY291bnRzIGxpc3RzIG9uIG9yZ2FuaXphdGlvbnMgbGlzdCBjaGFuZ2VcbiAgICAkc2NvcGUuJHdhdGNoICgtPiB3LnNlbGVjdGVkT3JnYW5pemF0aW9ucyksIChyZXN1bHQpIC0+XG4gICAgICB3LnVwZGF0ZVNldHRpbmdzKCkgaWYgIV8uaXNFbXB0eShyZXN1bHQpXG4gICAgLHRydWVcblxuICAgICRzY29wZS5mb3JtdWxhTW9kYWwuY2FuY2VsID0gLT5cbiAgICAgIHcuaW5pdFNldHRpbmdzKClcbiAgICAgICRzY29wZS5mb3JtdWxhTW9kYWwuY2xvc2UoKVxuXG4gICAgJHNjb3BlLmZvcm11bGFNb2RhbC5wcm9jZWVkID0gLT5cbiAgICAgIHcudXBkYXRlU2V0dGluZ3MoZmFsc2UpXG4gICAgICAkc2NvcGUuZm9ybXVsYU1vZGFsLmNsb3NlKClcbiAgICBcbiAgICAkc2NvcGUuZm9ybXVsYU1vZGFsLmNsb3NlID0gLT5cbiAgICAgICRzY29wZS5mb3JtdWxhTW9kYWwuJGluc3RhbmNlLmNsb3NlKClcblxuICAgICMgT3BlbiB0aGUgbW9kYWwgb24gdG9vZ2xlRWRpdE1vZGUoKVxuICAgICRzY29wZS4kd2F0Y2ggKC0+IHcuaXNFZGl0TW9kZSksIChyZXN1bHQsIHByZXYpIC0+XG4gICAgICAkc2NvcGUuZm9ybXVsYU1vZGFsLm9wZW4oKSBpZiByZXN1bHQgJiYgIXByZXZcblxuXG4gICAgIyBUT0RPOiBSZWZhY3RvciBvbmNlIHdlIGhhdmUgdW5kZXJzdG9vZCBleGFjdGx5IGhvdyB0aGUgYW5ndWxhcmpzIGNvbXBpbGF0aW9uIHByb2Nlc3Mgd29ya3M6XG4gICAgIyBpbiB0aGlzIG9yZGVyLCB3ZSBzaG91bGQ6XG4gICAgIyAxLSBjb21waWxlIGltcGFjLXdpZGdldCBjb250cm9sbGVyXG4gICAgIyAyLSBjb21waWxlIHRoZSBzcGVjaWZpYyB3aWRnZXQgdGVtcGxhdGUvY29udHJvbGxlclxuICAgICMgMy0gY29tcGlsZSB0aGUgc2V0dGluZ3MgdGVtcGxhdGVzL2NvbnRyb2xsZXJzXG4gICAgIyA0LSBjYWxsIHdpZGdldC5sb2FkQ29udGVudCgpIChpZGVhbGx5LCBmcm9tIGltcGFjLXdpZGdldCwgb25jZSBhIGNhbGxiYWNrIFxuICAgICMgICAgIGFzc2Vzc2luZyB0aGF0IGV2ZXJ5dGhpbmcgaXMgY29tcGlsZWQgYW4gcmVhZHkgaXMgcmVjZWl2ZWQpXG4gICAgZ2V0U2V0dGluZ3NDb3VudCA9IC0+XG4gICAgICBpZiB3LnNldHRpbmdzP1xuICAgICAgICByZXR1cm4gdy5zZXR0aW5ncy5sZW5ndGhcbiAgICAgIGVsc2VcbiAgICAgICAgcmV0dXJuIDBcblxuICAgICRzY29wZS4kd2F0Y2ggZ2V0U2V0dGluZ3NDb3VudCwgKHRvdGFsKSAtPlxuICAgICAgaWYgdG90YWwgPT0gMyAmJiAhJHNjb3BlLmJsb2NrTG9hZENvbnRlbnRcbiAgICAgICAgdy5sb2FkQ29udGVudCgpXG4gICAgICAgICRzY29wZS5ibG9ja0xvYWRDb250ZW50ID0gdHJ1ZVxuXG4gICAgcmV0dXJuIHdcbl0pXG5cbm1vZHVsZS5kaXJlY3RpdmUoJ3dpZGdldEFjY291bnRzQ3VzdG9tQ2FsY3VsYXRpb24nLCAtPlxuICByZXR1cm4ge1xuICAgIHJlc3RyaWN0OiAnQScsXG4gICAgbGluazogKHNjb3BlLCBlbGVtZW50KSAtPlxuICAgICAgZWxlbWVudC5hZGRDbGFzcyhcImFjY291bnRzXCIpXG4gICAgICBlbGVtZW50LmFkZENsYXNzKFwiY3VzdG9tLWNhbGN1bGF0aW9uXCIpXG4gICAgLGNvbnRyb2xsZXI6ICdXaWRnZXRBY2NvdW50c0N1c3RvbUNhbGN1bGF0aW9uQ3RybCdcbiAgfVxuKSJdfQ==