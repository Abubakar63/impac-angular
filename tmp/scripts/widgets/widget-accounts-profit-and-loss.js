(function () {
var module;

module = angular.module('maestrano.analytics.widget-accounts-profit-and-loss', ['maestrano.assets']);

module.controller('WidgetAccountsProfitAndLossCtrl', [
  '$scope', 'DhbAnalyticsSvc', 'ChartFormatterSvc', '$filter', function($scope, DhbAnalyticsSvc, ChartFormatterSvc, $filter) {
    var getSettingsCount, selectedElementsSetting, unCollapsedSetting, w;
    w = $scope.widget;
    w.initContext = function() {
      if ($scope.isDataFound = angular.isDefined(w.content) && !_.isEmpty(w.content.summary) && !_.isEmpty(w.content.dates)) {
        $scope.dates = w.content.dates;
        $scope.unCollapsed = w.metadata.unCollapsed || [];
        if (w.metadata.selectedElements) {
          $scope.selectedElements = [];
          angular.forEach(w.metadata.selectedElements, function(sElem) {
            var foundElem;
            foundElem = _.find(w.content.summary, function(statement) {
              return statement.name === sElem.name;
            });
            if (!foundElem) {
              angular.forEach(w.content.summary, function(statement) {
                if (statement.accounts != null) {
                  return foundElem || (foundElem = _.find(statement.accounts, function(account) {
                    return sElem.id === account.id;
                  }));
                }
              });
            }
            if (foundElem) {
              return $scope.selectedElements.push(foundElem);
            }
          });
        }
        if (!(($scope.selectedElements != null) && $scope.selectedElements.length > 0)) {
          return w.width = 6;
        }
      }
    };
    w.format = function() {
      var all_values_are_positive, inputData, options;
      if ($scope.isDataFound && ($scope.selectedElements != null) && $scope.selectedElements.length > 0) {
        all_values_are_positive = true;
        inputData = [];
        angular.forEach($scope.selectedElements, function(sElem) {
          var data, labels;
          data = angular.copy(sElem);
          labels = _.map(w.content.dates, function(date) {
            if (w.metadata.hist_parameters && w.metadata.hist_parameters.period === "YEARLY") {
              return $filter('date')(date, 'yyyy');
            } else if (w.metadata.hist_parameters && w.metadata.hist_parameters.period === "QUARTERLY") {
              return $filter('date')(date, 'MMM-yy');
            } else if (w.metadata.hist_parameters && (w.metadata.hist_parameters.period === "WEEKLY" || w.metadata.hist_parameters.period === "DAILY")) {
              return $filter('date')(date, 'dd-MMM');
            } else {
              return $filter('date')(date, 'MMM');
            }
          });
          inputData.push({
            title: data.name,
            labels: labels,
            values: data.totals
          });
          return angular.forEach(data.totals, function(value) {
            return all_values_are_positive && (all_values_are_positive = value >= 0);
          });
        });
        options = {
          scaleBeginAtZero: all_values_are_positive,
          showXLabels: true,
          datasetFill: $scope.selectedElements.length === 1,
          pointDot: $scope.selectedElements.length === 1
        };
        return w.chart = ChartFormatterSvc.lineChart(inputData, options);
      }
    };
    $scope.getElementChartColor = function(index) {
      return ChartFormatterSvc.getColor(index);
    };
    $scope.getLastDate = function() {
      if ($scope.dates != null) {
        return _.last($scope.dates);
      }
    };
    $scope.getLastValue = function(element) {
      if (element.totals != null) {
        return _.last(element.totals);
      }
    };
    $scope.getClassColor = function(aTotal) {
      if (parseInt(aTotal) > 0) {
        return 'positive';
      } else if (parseInt(aTotal) < 0) {
        return 'negative';
      } else {
        return null;
      }
    };
    $scope.getName = function(element) {
      if ((element != null) && (element.name != null)) {
        return element.name.replace(/_/g, " ");
      }
    };
    $scope.toogleSelectedElement = function(element) {
      if ($scope.isSelected(element)) {
        $scope.selectedElements = _.reject($scope.selectedElements, function(sElem) {
          if (element.id) {
            return sElem.id === element.id;
          } else {
            return sElem.name === element.name;
          }
        });
        w.format();
        if (w.isExpanded() && $scope.selectedElements.length === 0) {
          return w.toogleExpanded();
        } else {
          return w.updateSettings(false);
        }
      } else {
        $scope.selectedElements || ($scope.selectedElements = []);
        $scope.selectedElements.push(element);
        w.format();
        if (!w.isExpanded()) {
          return w.toogleExpanded();
        } else {
          return w.updateSettings(false);
        }
      }
    };
    $scope.isSelected = function(element) {
      if ((element != null) && ($scope.selectedElements != null)) {
        if (_.find($scope.selectedElements, function(sElem) {
          if (element.id) {
            return sElem.id === element.id;
          } else {
            return sElem.name === element.name;
          }
        })) {
          return true;
        } else {
          return false;
        }
      } else {
        return false;
      }
    };
    $scope.toogleCollapsed = function(element) {
      if ((element != null) && (element.name != null)) {
        if (_.find($scope.unCollapsed, (function(name) {
          return element.name === name;
        }))) {
          $scope.unCollapsed = _.reject($scope.unCollapsed, function(name) {
            return name === element.name;
          });
        } else {
          $scope.unCollapsed.push(element.name);
        }
        return w.updateSettings(false);
      }
    };
    $scope.isCollapsed = function(element) {
      if ((element != null) && (element.name != null)) {
        if (_.find($scope.unCollapsed, (function(name) {
          return element.name === name;
        }))) {
          return false;
        } else {
          return true;
        }
      }
    };
    unCollapsedSetting = {};
    unCollapsedSetting.initialized = false;
    unCollapsedSetting.initialize = function() {
      return unCollapsedSetting.initialized = true;
    };
    unCollapsedSetting.toMetadata = function() {
      return {
        unCollapsed: $scope.unCollapsed
      };
    };
    w.settings.push(unCollapsedSetting);
    selectedElementsSetting = {};
    selectedElementsSetting.initialized = false;
    selectedElementsSetting.initialize = function() {
      return selectedElementsSetting.initialized = true;
    };
    selectedElementsSetting.toMetadata = function() {
      return {
        selectedElements: $scope.selectedElements
      };
    };
    w.settings.push(selectedElementsSetting);
    getSettingsCount = function() {
      if (w.settings != null) {
        return w.settings.length;
      } else {
        return 0;
      }
    };
    $scope.$watch(getSettingsCount, function(total) {
      if (total >= 5) {
        return w.loadContent();
      }
    });
    return w;
  }
]);

module.directive('widgetAccountsProfitAndLoss', function() {
  return {
    restrict: 'A',
    link: function(scope, element) {
      element.addClass("accounts");
      return element.addClass("profit-and-loss");
    },
    controller: 'WidgetAccountsProfitAndLossCtrl'
  };
});
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndpZGdldHMvd2lkZ2V0LWFjY291bnRzLXByb2ZpdC1hbmQtbG9zcy5qcy5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBQTs7QUFBQSxNQUFBLEdBQVMsT0FBTyxDQUFDLE1BQVIsQ0FBZSxxREFBZixFQUFxRSxDQUFDLGtCQUFELENBQXJFOztBQUVULE1BQU0sQ0FBQyxVQUFQLENBQWtCLGlDQUFsQixFQUFvRDtFQUNsRCxRQURrRCxFQUN4QyxpQkFEd0MsRUFDckIsbUJBRHFCLEVBQ0EsU0FEQSxFQUVsRCxTQUFDLE1BQUQsRUFBUyxlQUFULEVBQTBCLGlCQUExQixFQUE2QyxPQUE3QztBQUVFLFFBQUE7SUFBQSxDQUFBLEdBQUksTUFBTSxDQUFDO0lBRVgsQ0FBQyxDQUFDLFdBQUYsR0FBZ0IsU0FBQTtNQUNkLElBQUcsTUFBTSxDQUFDLFdBQVAsR0FBcUIsT0FBTyxDQUFDLFNBQVIsQ0FBa0IsQ0FBQyxDQUFDLE9BQXBCLENBQUEsSUFBZ0MsQ0FBQyxDQUFDLENBQUMsT0FBRixDQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBcEIsQ0FBakMsSUFBaUUsQ0FBQyxDQUFDLENBQUMsT0FBRixDQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBcEIsQ0FBMUY7UUFFRSxNQUFNLENBQUMsS0FBUCxHQUFlLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDekIsTUFBTSxDQUFDLFdBQVAsR0FBcUIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFYLElBQTBCO1FBRS9DLElBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxnQkFBZDtVQUNFLE1BQU0sQ0FBQyxnQkFBUCxHQUEwQjtVQUMxQixPQUFPLENBQUMsT0FBUixDQUFnQixDQUFDLENBQUMsUUFBUSxDQUFDLGdCQUEzQixFQUE2QyxTQUFDLEtBQUQ7QUFDM0MsZ0JBQUE7WUFBQSxTQUFBLEdBQVksQ0FBQyxDQUFDLElBQUYsQ0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQWpCLEVBQTBCLFNBQUMs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O0lBRUEsdUJBQUEsR0FBMEI7SUFDMUIsdUJBQXVCLENBQUMsV0FBeEIsR0FBc0M7SUFFdEMsdUJBQXVCLENBQUMsVUFBeEIsR0FBcUMsU0FBQTthQUNuQyx1QkFBdUIsQ0FBQyxXQUF4QixHQUFzQztJQURIO0lBR3JDLHVCQUF1QixDQUFDLFVBQXhCLEdBQXFDLFNBQUE7YUFDbkM7UUFBQyxnQkFBQSxFQUFrQixNQUFNLENBQUMsZ0JBQTFCOztJQURtQztJQUdyQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQVgsQ0FBZ0IsdUJBQWhCO0lBV0EsZ0JBQUEsR0FBbUIsU0FBQTtNQUNqQixJQUFHLGtCQUFIO0FBQ0UsZUFBTyxDQUFDLENBQUMsUUFBUSxDQUFDLE9BRHBCO09BQUEsTUFBQTtBQUdFLGVBQU8sRUFIVDs7SUFEaUI7SUFPbkIsTUFBTSxDQUFDLE1BQVAsQ0FBYyxnQkFBZCxFQUFnQyxTQUFDLEtBQUQ7TUFDOUIsSUFBbUIsS0FBQSxJQUFTLENBQTVCO2VBQUEsQ0FBQyxDQUFDLFdBQUYsQ0FBQSxFQUFBOztJQUQ4QixDQUFoQztBQUdBLFdBQU87RUF2TFQsQ0FGa0Q7Q0FBcEQ7O0FBNExBLE1BQU0sQ0FBQyxTQUFQLENBQWlCLDZCQUFqQixFQUFnRCxTQUFBO0FBQzlDLFNBQU87SUFDTCxRQUFBLEVBQVUsR0FETDtJQUVMLElBQUEsRUFBTSxTQUFDLEtBQUQsRUFBUSxPQUFSO01BQ0osT0FBTyxDQUFDLFFBQVIsQ0FBaUIsVUFBakI7YUFDQSxPQUFPLENBQUMsUUFBUixDQUFpQixpQkFBakI7SUFGSSxDQUZEO0lBS0osVUFBQSxFQUFZLGlDQUxSOztBQUR1QyxDQUFoRCIsImZpbGUiOiJ3aWRnZXRzL3dpZGdldC1hY2NvdW50cy1wcm9maXQtYW5kLWxvc3MuanMuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJtb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnbWFlc3RyYW5vLmFuYWx5dGljcy53aWRnZXQtYWNjb3VudHMtcHJvZml0LWFuZC1sb3NzJyxbJ21hZXN0cmFuby5hc3NldHMnXSlcblxubW9kdWxlLmNvbnRyb2xsZXIoJ1dpZGdldEFjY291bnRzUHJvZml0QW5kTG9zc0N0cmwnLFtcbiAgJyRzY29wZScsICdEaGJBbmFseXRpY3NTdmMnLCAnQ2hhcnRGb3JtYXR0ZXJTdmMnLCAnJGZpbHRlcicsXG4gICgkc2NvcGUsIERoYkFuYWx5dGljc1N2YywgQ2hhcnRGb3JtYXR0ZXJTdmMsICRmaWx0ZXIpIC0+XG5cbiAgICB3ID0gJHNjb3BlLndpZGdldFxuXG4gICAgdy5pbml0Q29udGV4dCA9IC0+XG4gICAgICBpZiAkc2NvcGUuaXNEYXRhRm91bmQgPSBhbmd1bGFyLmlzRGVmaW5lZCh3LmNvbnRlbnQpICYmICFfLmlzRW1wdHkody5jb250ZW50LnN1bW1hcnkpICYmICFfLmlzRW1wdHkody5jb250ZW50LmRhdGVzKVxuXG4gICAgICAgICRzY29wZS5kYXRlcyA9IHcuY29udGVudC5kYXRlc1xuICAgICAgICAkc2NvcGUudW5Db2xsYXBzZWQgPSB3Lm1ldGFkYXRhLnVuQ29sbGFwc2VkIHx8IFtdXG5cbiAgICAgICAgaWYgdy5tZXRhZGF0YS5zZWxlY3RlZEVsZW1lbnRzXG4gICAgICAgICAgJHNjb3BlLnNlbGVjdGVkRWxlbWVudHMgPSBbXVxuICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh3Lm1ldGFkYXRhLnNlbGVjdGVkRWxlbWVudHMsIChzRWxlbSkgLT5cbiAgICAgICAgICAgIGZvdW5kRWxlbSA9IF8uZmluZCh3LmNvbnRlbnQuc3VtbWFyeSwgKHN0YXRlbWVudCktPlxuICAgICAgICAgICAgICBzdGF0ZW1lbnQubmFtZSA9PSBzRWxlbS5uYW1lXG4gICAgICAgICAgICApXG5cbiAgICAgICAgICAgIGlmICFmb3VuZEVsZW1cbiAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHcuY29udGVudC5zdW1tYXJ5LCAoc3RhdGVtZW50KSAtPlxuICAgICAgICAgICAgICAgIGZvdW5kRWxlbSB8fD0gXy5maW5kKHN0YXRlbWVudC5hY2NvdW50cywgKGFjY291bnQpLT5cbiAgICAgICAgICAgICAgICAgIHNFbGVtLmlkID09IGFjY291bnQuaWRcbiAgICAgICAgICAgICAgICApIGlmIHN0YXRlbWVudC5hY2NvdW50cz9cbiAgICAgICAgICAgICAgKVxuXG4gICAgICAgICAgICAkc2NvcGUuc2VsZWN0ZWRFbGVtZW50cy5wdXNoKGZvdW5kRWxlbSkgaWYgZm91bmRFbGVtXG4gICAgICAgICAgKVxuXG4gICAgICAgIHcud2lkdGggPSA2IHVubGVzcyAkc2NvcGUuc2VsZWN0ZWRFbGVtZW50cz8gJiYgJHNjb3BlLnNlbGVjdGVkRWxlbWVudHMubGVuZ3RoID4gMFxuXG4gICAgdy5mb3JtYXQgPSAtPlxuICAgICAgaWYgJHNjb3BlLmlzRGF0YUZvdW5kICYmICRzY29wZS5zZWxlY3RlZEVsZW1lbnRzPyAmJiAkc2NvcGUuc2VsZWN0ZWRFbGVtZW50cy5sZW5ndGggPiAwXG4gICAgICAgIGFsbF92YWx1ZXNfYXJlX3Bvc2l0aXZlID0gdHJ1ZVxuICAgICAgICBcbiAgICAgICAgaW5wdXREYXRhID0gW11cbiAgICAgICAgYW5ndWxhci5mb3JFYWNoKCRzY29wZS5zZWxlY3RlZEVsZW1lbnRzLCAoc0VsZW0pIC0+XG4gICAgICAgICAgZGF0YSA9IGFuZ3VsYXIuY29weShzRWxlbSlcbiAgICAgICAgICBcbiAgICAgICAgICBsYWJlbHMgPSBfLm1hcCB3LmNvbnRlbnQuZGF0ZXMsIChkYXRlKSAtPlxuICAgICAgICAgICAgaWYgdy5tZXRhZGF0YS5oaXN0X3BhcmFtZXRlcnMgJiYgdy5tZXRhZGF0YS5oaXN0X3BhcmFtZXRlcnMucGVyaW9kID09IFwiWUVBUkxZXCJcbiAgICAgICAgICAgICAgJGZpbHRlcignZGF0ZScpKGRhdGUsICd5eXl5JylcbiAgICAgICAgICAgIGVsc2UgaWYgdy5tZXRhZGF0YS5oaXN0X3BhcmFtZXRlcnMgJiYgdy5tZXRhZGF0YS5oaXN0X3BhcmFtZXRlcnMucGVyaW9kID09IFwiUVVBUlRFUkxZXCJcbiAgICAgICAgICAgICAgJGZpbHRlcignZGF0ZScpKGRhdGUsICdNTU0teXknKVxuICAgICAgICAgICAgZWxzZSBpZiB3Lm1ldGFkYXRhLmhpc3RfcGFyYW1ldGVycyAmJiAody5tZXRhZGF0YS5oaXN0X3BhcmFtZXRlcnMucGVyaW9kID09IFwiV0VFS0xZXCIgfHwgdy5tZXRhZGF0YS5oaXN0X3BhcmFtZXRlcnMucGVyaW9kID09IFwiREFJTFlcIilcbiAgICAgICAgICAgICAgJGZpbHRlcignZGF0ZScpKGRhdGUsICdkZC1NTU0nKVxuICAgICAgICAgICAgZWxzZSAgXG4gICAgICAgICAgICAgICRmaWx0ZXIoJ2RhdGUnKShkYXRlLCAnTU1NJylcbiAgICAgICAgICBcbiAgICAgICAgICBpbnB1dERhdGEucHVzaCh7dGl0bGU6IGRhdGEubmFtZSwgbGFiZWxzOiBsYWJlbHMsIHZhbHVlczogZGF0YS50b3RhbHN9KVxuICAgICAgICAgIFxuICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRhLnRvdGFscywgKHZhbHVlKSAtPlxuICAgICAgICAgICAgYWxsX3ZhbHVlc19hcmVfcG9zaXRpdmUgJiY9IHZhbHVlID49IDBcbiAgICAgICAgICApXG4gICAgICAgIClcblxuICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgIHNjYWxlQmVnaW5BdFplcm86IGFsbF92YWx1ZXNfYXJlX3Bvc2l0aXZlLFxuICAgICAgICAgIHNob3dYTGFiZWxzOiB0cnVlLFxuICAgICAgICAgIGRhdGFzZXRGaWxsOiAkc2NvcGUuc2VsZWN0ZWRFbGVtZW50cy5sZW5ndGggPT0gMSxcbiAgICAgICAgICBwb2ludERvdDogJHNjb3BlLnNlbGVjdGVkRWxlbWVudHMubGVuZ3RoID09IDEsXG4gICAgICAgIH1cblxuICAgICAgICB3LmNoYXJ0ID0gQ2hhcnRGb3JtYXR0ZXJTdmMubGluZUNoYXJ0KGlucHV0RGF0YSxvcHRpb25zKVxuXG4gICAgJHNjb3BlLmdldEVsZW1lbnRDaGFydENvbG9yID0gKGluZGV4KSAtPlxuICAgICAgQ2hhcnRGb3JtYXR0ZXJTdmMuZ2V0Q29sb3IoaW5kZXgpXG5cbiAgICAkc2NvcGUuZ2V0TGFzdERhdGUgPSAtPlxuICAgICAgXy5sYXN0KCRzY29wZS5kYXRlcykgaWYgJHNjb3BlLmRhdGVzP1xuXG4gICAgJHNjb3BlLmdldExhc3RWYWx1ZSA9IChlbGVtZW50KSAtPlxuICAgICAgXy5sYXN0KGVsZW1lbnQudG90YWxzKSBpZiBlbGVtZW50LnRvdGFscz9cblxuICAgICRzY29wZS5nZXRDbGFzc0NvbG9yID0gKGFUb3RhbCkgLT5cbiAgICAgIGlmIHBhcnNlSW50KGFUb3RhbCkgPiAwXG4gICAgICAgIHJldHVybiAncG9zaXRpdmUnXG4gICAgICBlbHNlIGlmIHBhcnNlSW50KGFUb3RhbCkgPCAwXG4gICAgICAgIHJldHVybiAnbmVnYXRpdmUnXG4gICAgICBlbHNlXG4gICAgICAgIHJldHVybiBudWxsXG5cbiAgICAkc2NvcGUuZ2V0TmFtZSA9IChlbGVtZW50KSAtPlxuICAgICAgZWxlbWVudC5uYW1lLnJlcGxhY2UoL18vZywgXCIgXCIpIGlmIGVsZW1lbnQ/ICYmIGVsZW1lbnQubmFtZT9cblxuXG4jIFRPRE8gc2VsZWN0ZWRFbGVtZW50IGFuZCBjb2xsYXBzZWQgc2hvdWxkIGJlIGZhY3Rvcml6ZWQgYXMgc2V0dGluZ3Mgb3IgJ2NvbW1vbnMnXG5cbiAgICAkc2NvcGUudG9vZ2xlU2VsZWN0ZWRFbGVtZW50ID0gKGVsZW1lbnQpIC0+XG4gICAgICBpZiAkc2NvcGUuaXNTZWxlY3RlZChlbGVtZW50KVxuICAgICAgICAkc2NvcGUuc2VsZWN0ZWRFbGVtZW50cyA9IF8ucmVqZWN0KCRzY29wZS5zZWxlY3RlZEVsZW1lbnRzLCAoc0VsZW0pIC0+XG4gICAgICAgICAgaWYgZWxlbWVudC5pZFxuICAgICAgICAgICAgc0VsZW0uaWQgPT0gZWxlbWVudC5pZFxuICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgIHNFbGVtLm5hbWUgPT0gZWxlbWVudC5uYW1lXG4gICAgICAgIClcbiAgICAgICAgdy5mb3JtYXQoKVxuICAgICAgICBpZiB3LmlzRXhwYW5kZWQoKSAmJiAkc2NvcGUuc2VsZWN0ZWRFbGVtZW50cy5sZW5ndGggPT0gMFxuICAgICAgICAgIHcudG9vZ2xlRXhwYW5kZWQoKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgdy51cGRhdGVTZXR0aW5ncyhmYWxzZSlcbiAgICAgIGVsc2VcbiAgICAgICAgJHNjb3BlLnNlbGVjdGVkRWxlbWVudHMgfHw9IFtdXG4gICAgICAgICRzY29wZS5zZWxlY3RlZEVsZW1lbnRzLnB1c2goZWxlbWVudClcbiAgICAgICAgdy5mb3JtYXQoKVxuICAgICAgICBpZiAhdy5pc0V4cGFuZGVkKClcbiAgICAgICAgICB3LnRvb2dsZUV4cGFuZGVkKClcbiAgICAgICAgZWxzZVxuICAgICAgICAgIHcudXBkYXRlU2V0dGluZ3MoZmFsc2UpXG5cbiAgICAkc2NvcGUuaXNTZWxlY3RlZCA9IChlbGVtZW50KSAtPlxuICAgICAgaWYgZWxlbWVudD8gJiYgJHNjb3BlLnNlbGVjdGVkRWxlbWVudHM/XG4gICAgICAgIGlmIF8uZmluZCgkc2NvcGUuc2VsZWN0ZWRFbGVtZW50cywgKHNFbGVtKSAtPlxuICAgICAgICAgIGlmIGVsZW1lbnQuaWRcbiAgICAgICAgICAgIHNFbGVtLmlkID09IGVsZW1lbnQuaWRcbiAgICAgICAgICBlbHNlXG4gICAgICAgICAgICBzRWxlbS5uYW1lID09IGVsZW1lbnQubmFtZVxuICAgICAgICApXG4gICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgZWxzZVxuICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgZWxzZSBcbiAgICAgICAgcmV0dXJuIGZhbHNlXG5cbiAgICAkc2NvcGUudG9vZ2xlQ29sbGFwc2VkID0gKGVsZW1lbnQpIC0+XG4gICAgICBpZiBlbGVtZW50PyAmJiBlbGVtZW50Lm5hbWU/ICBcbiAgICAgICAgaWYgXy5maW5kKCRzY29wZS51bkNvbGxhcHNlZCwgKChuYW1lKSAtPiBlbGVtZW50Lm5hbWUgPT0gbmFtZSkpXG4gICAgICAgICAgJHNjb3BlLnVuQ29sbGFwc2VkID0gXy5yZWplY3QoJHNjb3BlLnVuQ29sbGFwc2VkLCAobmFtZSkgLT5cbiAgICAgICAgICAgIG5hbWUgPT0gZWxlbWVudC5uYW1lXG4gICAgICAgICAgKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgJHNjb3BlLnVuQ29sbGFwc2VkLnB1c2goZWxlbWVudC5uYW1lKVxuICAgICAgICB3LnVwZGF0ZVNldHRpbmdzKGZhbHNlKVxuXG4gICAgJHNjb3BlLmlzQ29sbGFwc2VkID0gKGVsZW1lbnQpIC0+XG4gICAgICBpZiBlbGVtZW50PyAmJiBlbGVtZW50Lm5hbWU/ICBcbiAgICAgICAgaWYgXy5maW5kKCRzY29wZS51bkNvbGxhcHNlZCwgKChuYW1lKSAtPiBlbGVtZW50Lm5hbWUgPT0gbmFtZSkpXG4gICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIGVsc2VcbiAgICAgICAgICByZXR1cm4gdHJ1ZVxuXG5cbiAgICAjICMjIyBNaW5pLXNldHRpbmdzXG5cbiAgICB1bkNvbGxhcHNlZFNldHRpbmcgPSB7fVxuICAgIHVuQ29sbGFwc2VkU2V0dGluZy5pbml0aWFsaXplZCA9IGZhbHNlXG4gICAgXG4gICAgdW5Db2xsYXBzZWRTZXR0aW5nLmluaXRpYWxpemUgPSAtPlxuICAgICAgdW5Db2xsYXBzZWRTZXR0aW5nLmluaXRpYWxpemVkID0gdHJ1ZVxuXG4gICAgdW5Db2xsYXBzZWRTZXR0aW5nLnRvTWV0YWRhdGEgPSAtPlxuICAgICAge3VuQ29sbGFwc2VkOiAkc2NvcGUudW5Db2xsYXBzZWR9XG5cbiAgICB3LnNldHRpbmdzLnB1c2godW5Db2xsYXBzZWRTZXR0aW5nKVxuXG4gICAgc2VsZWN0ZWRFbGVtZW50c1NldHRpbmcgPSB7fVxuICAgIHNlbGVjdGVkRWxlbWVudHNTZXR0aW5nLmluaXRpYWxpemVkID0gZmFsc2VcbiAgICBcbiAgICBzZWxlY3RlZEVsZW1lbnRzU2V0dGluZy5pbml0aWFsaXplID0gLT5cbiAgICAgIHNlbGVjdGVkRWxlbWVudHNTZXR0aW5nLmluaXRpYWxpemVkID0gdHJ1ZVxuXG4gICAgc2VsZWN0ZWRFbGVtZW50c1NldHRpbmcudG9NZXRhZGF0YSA9IC0+XG4gICAgICB7c2VsZWN0ZWRFbGVtZW50czogJHNjb3BlLnNlbGVjdGVkRWxlbWVudHN9XG5cbiAgICB3LnNldHRpbmdzLnB1c2goc2VsZWN0ZWRFbGVtZW50c1NldHRpbmcpXG5cbiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICAjIFRPRE86IFJlZmFjdG9yIG9uY2Ugd2UgaGF2ZSB1bmRlcnN0b29kIGV4YWN0bHkgaG93IHRoZSBhbmd1bGFyanMgY29tcGlsYXRpb24gcHJvY2VzcyB3b3JrczpcbiAgICAjIGluIHRoaXMgb3JkZXIsIHdlIHNob3VsZDpcbiAgICAjIDEtIGNvbXBpbGUgaW1wYWMtd2lkZ2V0IGNvbnRyb2xsZXJcbiAgICAjIDItIGNvbXBpbGUgdGhlIHNwZWNpZmljIHdpZGdldCB0ZW1wbGF0ZS9jb250cm9sbGVyXG4gICAgIyAzLSBjb21waWxlIHRoZSBzZXR0aW5ncyB0ZW1wbGF0ZXMvY29udHJvbGxlcnNcbiAgICAjIDQtIGNhbGwgd2lkZ2V0LmxvYWRDb250ZW50KCkgKGlkZWFsbHksIGZyb20gaW1wYWMtd2lkZ2V0LCBvbmNlIGEgY2FsbGJhY2sgXG4gICAgIyAgICAgYXNzZXNzaW5nIHRoYXQgZXZlcnl0aGluZyBpcyBjb21waWxlZCBhbiByZWFkeSBpcyByZWNlaXZlZClcbiAgICBnZXRTZXR0aW5nc0NvdW50ID0gLT5cbiAgICAgIGlmIHcuc2V0dGluZ3M/XG4gICAgICAgIHJldHVybiB3LnNldHRpbmdzLmxlbmd0aFxuICAgICAgZWxzZVxuICAgICAgICByZXR1cm4gMFxuXG4gICAgIyB3aWR0aCArIGhpc3RfcGFyYW1ldGVycyArIG9yZ2FuaXphdGlvbl9pZHMgKyB1bkNvbGxhcHNlZCArIHNlbGVjdGVkRWxlbWVudFxuICAgICRzY29wZS4kd2F0Y2ggZ2V0U2V0dGluZ3NDb3VudCwgKHRvdGFsKSAtPlxuICAgICAgdy5sb2FkQ29udGVudCgpIGlmIHRvdGFsID49IDVcblxuICAgIHJldHVybiB3XG5dKVxuXG5tb2R1bGUuZGlyZWN0aXZlKCd3aWRnZXRBY2NvdW50c1Byb2ZpdEFuZExvc3MnLCAtPlxuICByZXR1cm4ge1xuICAgIHJlc3RyaWN0OiAnQScsXG4gICAgbGluazogKHNjb3BlLCBlbGVtZW50KSAtPlxuICAgICAgZWxlbWVudC5hZGRDbGFzcyhcImFjY291bnRzXCIpXG4gICAgICBlbGVtZW50LmFkZENsYXNzKFwicHJvZml0LWFuZC1sb3NzXCIpXG4gICAgLGNvbnRyb2xsZXI6ICdXaWRnZXRBY2NvdW50c1Byb2ZpdEFuZExvc3NDdHJsJ1xuICB9XG4pIl19